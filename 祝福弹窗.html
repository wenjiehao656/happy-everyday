<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>祝福弹窗</title>
<style>
  :root{ --pink:#ff69b4; --txt:#fff; }
  html,body{height:100%;margin:0;background:#000;overflow:hidden;-webkit-user-select:none;user-select:none;}
  #stage{position:fixed;inset:0;pointer-events:none;}
  .popup{
    position:fixed;
    left:50%;top:50%;
    transform-origin:center center;
    box-sizing:border-box;
    display:flex;align-items:center;justify-content:center;
    text-align:center;
    padding:6px;
    border-radius:12px;
    font-weight:700;
    color:var(--txt);
    background:linear-gradient(135deg, rgba(255,105,180,0.98), rgba(255,128,196,0.95));
    box-shadow:0 10px 30px rgba(0,0,0,0.35);
    opacity:0;
    will-change:transform,opacity;
    transition:transform 700ms cubic-bezier(.2,.9,.2,1),opacity 420ms;
    z-index:2;
    pointer-events:auto;
  }
  .popup.show{opacity:1;}
  .popup span{display:block;padding:2px 6px;line-height:1.05;font-size:0.95rem;word-break:keep-all;}
  @media (max-width:420px){
    .popup span{font-size:0.82rem}
  }
</style>
</head>
<body>
<div id="stage" aria-hidden="true"></div>

<script>
/* 说明：
 - 本页为静态单页：点击聊天中的链接打开后会从中心持续扩散弹出祝福弹窗，直到用户关闭页面。
 - 本版本已移除背景音乐相关代码，仅保留弹窗效果。
*/

// 祝福语
const messages = [
  "生日快乐！愿你万事顺意",
  "愿你笑口常开，岁岁平安",
  "Happy Birthday! Enjoy your day",
  "愿所有美好如期而至",
  "今天为你点亮幸福的灯",
  "年年有今日，岁岁有今朝",
  "愿你心想事成，好运常伴",
  "愿快乐与美好不请自来",
  "祝你被世界温柔以待",
  "愿你未来可期，光芒万丈",
  "愿你被爱包围，平安喜乐",
  "愿每一天都比蜜甜"
];

const stage = document.getElementById('stage');

function W(){ return window.innerWidth; }
function H(){ return window.innerHeight; }
// 弹窗边长 = 屏幕最短边 / 8
function popupSize(){
  return Math.max(56, Math.floor(Math.min(W(), H()) / 8));
}

// 计算目标点，保证弹窗完整可见
function randomTarget(size){
  const angle = Math.random() * Math.PI * 2;
  // 最大半径到屏幕边缘的距离（留白）
  const maxR = Math.min(W(), H()) * 0.48;
  const r = Math.random() * maxR;
  const tx = Math.cos(angle) * r;
  const ty = Math.sin(angle) * r;
  return {tx, ty};
}

// 生成一个弹窗，从中心向外扩散
function spawnOne(){
  const size = popupSize();
  const el = document.createElement('div');
  el.className = 'popup';
  el.style.width = size + 'px';
  el.style.height = size + 'px';
  const txt = document.createElement('span');
  txt.textContent = messages[Math.floor(Math.random() * messages.length)];
  el.appendChild(txt);

  // 初始放在中心（left/top 50%），transform 使用 translate 和 scale
  el.style.left = '50%';
  el.style.top = '50%';
  // small initial scale
  el.style.transform = `translate(-50%, -50%) scale(0.06)`;
  stage.appendChild(el);

  // 目标偏移
  const {tx, ty} = randomTarget(size);
  // 使用小随机延迟制造扩散感
  const delay = Math.random() * 420;

  setTimeout(()=>{
    // 移动到目标： translate(calc(-50% + tx px), calc(-50% + ty px))
    el.classList.add('show');
    el.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(1)`;
  }, delay);

  // 轻微浮动动画（通过 requestAnimationFrame 控制 transform 微调）
  const floatAmp = 6 + Math.random()*12;
  const floatDur = 2500 + Math.random()*3000;
  let t0 = performance.now() + delay;
  function floatStep(now){
    const dt = (now - t0) / floatDur;
    if(dt > 1) {
      t0 = now + Math.random()*800;
    }
    const fx = Math.sin((now + (Math.random()*1000)) / (500 + Math.random()*600)) * floatAmp;
    const fy = Math.cos((now + (Math.random()*1200)) / (600 + Math.random()*700)) * floatAmp;
    // append slight translate to current transform
    el.style.transform = `translate(calc(-50% + ${tx+fx}px), calc(-50% + ${ty+fy}px)) scale(1)`;
    if(stage.contains(el)) requestAnimationFrame(floatStep);
  }
  requestAnimationFrame(floatStep);

  // 点按消失互动
  el.addEventListener('click', ()=>{
    el.style.transition = 'transform 300ms ease, opacity 300ms';
    el.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(1.12)`;
    el.style.opacity = '0';
    setTimeout(()=> el.remove(), 320);
  });

  return el;
}

// 持续生成直到用户离开页面
let spawnTimer = null;
function startSpawning(rateMs = 350){
  if(spawnTimer) return;
  // initial small burst
  for(let i=0;i<4;i++) setTimeout(spawnOne, i*80);
  spawnTimer = setInterval(()=> {
    spawnOne();
    // 保留合理数量，避免内存无限增长：如果元素超出 250 个，移除最早的若干
    const children = stage.children;
    if(children.length > 250){
      for(let k=0;k<children.length-200;k++){
        children[k].remove();
      }
    }
  }, rateMs);
}
function stopSpawning(){
  if(spawnTimer){ clearInterval(spawnTimer); spawnTimer = null; }
}

// 在页面加载时开始（弹窗持续直到用户关闭页面）
window.addEventListener('load', ()=>{
  startSpawning(300);
  // 绑定一次性用户激活以确保在某些 webview 中也能触发交互（不涉及音频）
  document.body.addEventListener('click', ()=>{}, { once: true });
  document.body.addEventListener('touchstart', ()=>{}, { once: true });
});

// 页面不可见或卸载时停止生成
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    stopSpawning();
  } else {
    startSpawning(300);
  }
});
window.addEventListener('pagehide', ()=>{
  stopSpawning();
});
window.addEventListener('beforeunload', ()=>{
  stopSpawning();
});

// 适配屏幕旋转/尺寸变更：调整现有弹窗大小与位置（不移除）
window.addEventListener('resize', ()=>{
  const size = popupSize();
  Array.from(stage.children).forEach(el=>{
    if(!el.classList.contains('popup')) return;
    el.style.width = size + 'px';
    el.style.height = size + 'px';
  });
});
</script>
</body>
</html>
